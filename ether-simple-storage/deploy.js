const ethers = require("ethers"); // import ethers package
const fs = require("fs-extra"); // import fs-extra package
require("dotenv").config(); // import dotenv package

async function main() {
    // compile them in our code
    // http://127.0.0.1:7545

    const provider = new ethers.providers.JsonRpcProvider(process.env.RPC_URL); // connect to the local blockchain
    const encryptJsonKey = fs.readFileSync("./.encryptKey.json", "utf-8"); // read the encrypted key file
    let wallet = await ethers.Wallet.fromEncryptedJsonSync(encryptJsonKey, process.env.PASSWORD); // connect to the local wallet
    // const wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider); // connect to the local wallet
    wallet = wallet.connect(provider); // connect to the local wallet
    const abi = fs.readFileSync("./SimpleStorage_sol_SimpleStorage.abi", "utf-8"); // read the abi file
    const binary = fs.readFileSync("./SimpleStorage_sol_SimpleStorage.bin", "utf-8"); // read the binary file

    // here factory is an object that we can use to deploy the contract
    const factory = new ethers.ContractFactory(abi, binary, wallet); // create a contract factory
    console.log("Deploying contract...");
    const contract = await factory.deploy(); // await means => wait until the contract is deployed
    // Or
    const transactionReceipt = await contract.deployTransaction.wait(1); // wait for atleast 1 block confirmation
    // We only get a transaction receipt when you wait for atleast 1 block confirmation

    // Whereas the deployTransaction (transaction response) is what you get just when you create a transaction
    console.log("Contract deployed to address:", transactionReceipt);

    const myFavouriteNumber = await contract.retrieve(); // call the retrive function
    console.log(`My favourite number is: ${myFavouriteNumber.toString()}`); // print the number

    // let's update the number
    const updatedNumber = await contract.store("10"); // call the store function
    await updatedNumber.wait(1); // wait for atleast 1 block confirmation

    const updatedFavouriteNumber = await contract.retrieve(); // call the retrive function
    console.log(`Updated Number:  ${updatedFavouriteNumber.toString()}`); // print the transaction hash

    // let's deploy with only transaction data

    /* const nonce = await wallet.getTransactionCount(); // get the nonce
    const tx = { // if we want to know what happening under the hood
        nonce: nonce,
        gasPrice: 20000000000,
        gasLimit: 6721975,
        //gasLimit: ethers.utils.hexlify(1000000),
        to: '0x0000000000000000000000000000000000000000',
        value: 0,
        data: '0x608060405234801561001057600080fd5b50610f88806100206000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c80630ab0a42214610046578063bc8bc2b414610062578063ff9c335814610094575b600080fd5b610060600480360381019061005b919061079c565b6100c4565b005b61007c60048036038101906100779190610827565b6101cf565b60405161008b939291906108e2565b60405180910390f35b6100ae60048036038101906100a99190610985565b610319565b6040516100bb9190610b24565b60405180910390f35b600160405180606001604052808581526020018481526020018381525090806001815401808255809150506001900390600052602060002090600302016000909190919091506000820151816000015560208201518160010190816101299190610d52565b50604082015181600201908161013f9190610d52565b50505060016000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000209080546101909291906104e4565b507f3c981eaf8f806637941d1237961055d66e8636b71bc453db0c9e245a154760fd83836040516101c2929190610e24565b60405180910390a1505050565b600181815481106101df57600080fd5b906000526020600020906003020160009150905080600001549080600101805461020890610b75565b80601f016020809104026020016040519081016040528092919081815260200182805461023490610b75565b80156102815780601f1061025657610100808354040283529160200191610281565b820191906000526020600020905b81548152906001019060200180831161026457829003601f168201915b50505050509080600201805461029690610b75565b80601f01602080910402602001604051908101604052809291908181526020018280546102c290610b75565b801561030f5780601f106102e45761010080835404028352916020019161030f565b820191906000526020600020905b8154815290600101906020018083116102f257829003601f168201915b5050505050905083565b60606000808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020805480602002602001604051908101604052809291908181526020016000905b828210156104d95783829060005260206000209060030201604051806060016040529081600082015481526020016001820180546103b690610b75565b80601f01602080910402602001604051908101604052809291908181526020018280546103e290610b75565b801561042f5780601f106104045761010080835404028352916020019161042f565b820191906000526020600020905b81548152906001019060200180831161041257829003601f168201915b5050505050815260200160028201805461044890610b75565b80601f016020809104026020016040519081016040528092919081815260200182805461047490610b75565b80156104c15780601f10610496576101008083540402835291602001916104c1565b820191906000526020600020905b8154815290600101906020018083116104a457829003601f168201915b50505050508152505081526020019060010190610379565b505050509050919050565b82805482825590600052602060002090600302810192821561055f5760005260206000209160030282015b8281111561055e57828260008201548160000155600182018160010190816105379190610e6a565b506002820181600201908161054c9190610e6a565b5050509160030191906003019061050f565b5b50905061056c9190610570565b5090565b5b808211156105ab5760008082016000905560018201600061059291906105af565b6002820160006105a291906105af565b50600301610571565b5090565b5080546105bb90610b75565b6000825580601f106105cd57506105ec565b601f0160209004906000526020600020908101906105eb91906105ef565b5b50565b5b808211156106085760008160009055506001016105f0565b5090565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b61063381610620565b811461063e57600080fd5b50565b6000813590506106508161062a565b92915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6106a982610660565b810181811067ffffffffffffffff821117156106c8576106c7610671565b5b80604052505050565b60006106db61060c565b90506106e782826106a0565b919050565b600067ffffffffffffffff82111561070757610706610671565b5b61071082610660565b9050602081019050919050565b82818337600083830152505050565b600061073f61073a846106ec565b6106d1565b90508281526020810184848401111561075b5761075a61065b565b5b61076684828561071d565b509392505050565b600082601f83011261078357610782610656565b5b813561079384826020860161072c565b91505092915050565b6000806000606084860312156107b5576107b4610616565b5b60006107c386828701610641565b935050602084013567ffffffffffffffff8111156107e4576107e361061b565b5b6107f08682870161076e565b925050604084013567ffffffffffffffff8111156108115761081061061b565b5b61081d8682870161076e565b9150509250925092565b60006020828403121561083d5761083c610616565b5b600061084b84828501610641565b91505092915050565b61085d81610620565b82525050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561089d578082015181840152602081019050610882565b60008484015250505050565b60006108b482610863565b6108be818561086e565b93506108ce81856020860161087f565b6108d781610660565b840191505092915050565b60006060820190506108f76000830186610854565b818103602083015261090981856108a9565b9050818103604083015261091d81846108a9565b9050949350505050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061095282610927565b9050919050565b61096281610947565b811461096d57600080fd5b50565b60008135905061097f81610959565b92915050565b60006020828403121561099b5761099a610616565b5b60006109a984828501610970565b91505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6109e781610620565b82525050565b600082825260208201905092915050565b6000610a0982610863565b610a1381856109ed565b9350610a2381856020860161087f565b610a2c81610660565b840191505092915050565b6000606083016000830151610a4f60008601826109de565b5060208301518482036020860152610a6782826109fe565b91505060408301518482036040860152610a8182826109fe565b9150508091505092915050565b6000610a9a8383610a37565b905092915050565b6000602082019050919050565b6000610aba826109b2565b610ac481856109bd565b935083602082028501610ad6856109ce565b8060005b85811015610b125784840389528151610af38582610a8e565b9450610afe83610aa2565b925060208a01995050600181019050610ada565b50829750879550505050505092915050565b60006020820190508181036000830152610b3e8184610aaf565b905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610b8d57607f821691505b602082108103610ba057610b9f610b46565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302610c087fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610bcb565b610c128683610bcb565b95508019841693508086168417925050509392505050565b6000819050919050565b6000610c4f610c4a610c4584610620565b610c2a565b610620565b9050919050565b6000819050919050565b610c6983610c34565b610c7d610c7582610c56565b848454610bd8565b825550505050565b600090565b610c92610c85565b610c9d818484610c60565b505050565b5b81811015610cc157610cb6600082610c8a565b600181019050610ca3565b5050565b601f821115610d0657610cd781610ba6565b610ce084610bbb565b81016020851015610cef578190505b610d03610cfb85610bbb565b830182610ca2565b50505b505050565b600082821c905092915050565b6000610d2960001984600802610d0b565b1980831691505092915050565b6000610d428383610d18565b9150826002028217905092915050565b610d5b82610863565b67ffffffffffffffff811115610d7457610d73610671565b5b610d7e8254610b75565b610d89828285610cc5565b600060209050601f831160018114610dbc5760008415610daa578287015190505b610db48582610d36565b865550610e1c565b601f198416610dca86610ba6565b60005b82811015610df257848901518255600182019150602085019450602081019050610dcd565b86831015610e0f5784890151610e0b601f891682610d18565b8355505b6001600288020188555050505b505050505050565b6000604082019050610e396000830185610854565b8181036020830152610e4b81846108a9565b90509392505050565b600081549050610e6381610b75565b9050919050565b818103610e78575050610f50565b610e8182610e54565b67ffffffffffffffff811115610e9a57610e99610671565b5b610ea48254610b75565b610eaf828285610cc5565b6000601f831160018114610ede5760008415610ecc578287015490505b610ed68582610d36565b865550610f49565b601f198416610eec87610ba6565b9650610ef786610ba6565b60005b82811015610f1f57848901548255600182019150600185019450602081019050610efa565b86831015610f3c5784890154610f38601f891682610d18565b8355505b6001600288020188555050505b5050505050505b56fea26469706673582212207989251742c4339345b6cbfb53160461289b17ed5d186819acdd3295c263538564736f6c63430008110033',
        chainId: 1337,
    };

    const sentTxResponse = await wallet.sendTransaction(tx);
    console.log("Transaction sent: ", sentTxResponse.hash); */
}

main()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error(error);
        process.exit(1);
    });
